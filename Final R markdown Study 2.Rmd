---
title: "Study 2"
author: "Evan Valdes"
date: "9/24/2020"
output: html_document
---

```{r}
## Set working directory----
setwd("/Users/Evanvaldes1/Desktop/MASSEY/STUDY 2/CODE AND DATA/Thesis-DI2-Data-SJ-Study")
```

```{r}
library(dplyr)
library(stringr)
library(readr)
library(ggplot2)
library(psych) ## Can use for within and between correlations statsBy()
library(haven)
library(stats)
library(lavaan)
library(tableone)
library(semPlot)
library(semTools)
library(tidyverse)
library(PerformanceAnalytics)
library(ggiraphExtra)
library(equaltestMI)
library(stargazer)
library(apaTables)
library(jtools)
library(BaylorEdPsych)
library(lme4) ## Multilevel regression modeling
library(sjPlot)
library(flexplot) ## devtools::install_github("dustinfife/flexplot")
library(styler)
library(readxl)
library(reghelper) # Simple slopes for interactions
library(mlma) # Multilevel mediation analysis
library(cowplot) ## multiplots
library(influence.ME) ## Calculating cooks distance
```

## Opening indvidual and country level data
```{r}
full_evan_dataset <- read_sav("RAW DI2 DATA/Full Evan Dataset.zip")  

country_level <- read_sav("Country level analysis for DI2.zip")
```


## Full data - indvidual level analysis
```{r}
## Getting NA's instead of blanks for income and Salary
dat2 <- full_evan_dataset %>% mutate_at(
  .vars = c(
    "Income_1", "Income_2",
    "Income_3", "Income_4", "Salary_1", "Salary_2",
    "Salary_3", "Salary_4", "System_Justification"
  ),
  .funs = list(~ ifelse(. == "", NA, as.character(.)))
)
```

## Attaching country names
```{r}
dat2$Country <- as.character(dat2$Country)
dat2$Country[dat2$Country == 1] <- "Argentina"
dat2$Country[dat2$Country == 2] <- "Australia"
dat2$Country[dat2$Country == 3] <- "Bolivia"
dat2$Country[dat2$Country == 4] <- "Brazil"
dat2$Country[dat2$Country == 5] <- "Canada"
dat2$Country[dat2$Country == 6] <- "China"
dat2$Country[dat2$Country == 7] <- "Colombia"
dat2$Country[dat2$Country == 8] <- "Egypt"
dat2$Country[dat2$Country == 9] <- "Finland"
dat2$Country[dat2$Country == 10] <- "Germany"
dat2$Country[dat2$Country == 11] <- "Greece"
dat2$Country[dat2$Country == 12] <- "Hong Kong"
dat2$Country[dat2$Country == 13] <- "Hungary"
dat2$Country[dat2$Country == 14] <- "India"
dat2$Country[dat2$Country == 15] <- "Indonesia"
dat2$Country[dat2$Country == 16] <- "Italy"
dat2$Country[dat2$Country == 17] <- "Japan"
dat2$Country[dat2$Country == 18] <- "Kenya"
dat2$Country[dat2$Country == 19] <- "Malaysia"
dat2$Country[dat2$Country == 20] <- "Mexico"
dat2$Country[dat2$Country == 21] <- "Morocco"
dat2$Country[dat2$Country == 22] <- "Netherlands"
dat2$Country[dat2$Country == 23] <- "New Zealand"
dat2$Country[dat2$Country == 24] <- "Nigeria"
dat2$Country[dat2$Country == 25] <- "Pakistan"
dat2$Country[dat2$Country == 26] <- "Panama"
dat2$Country[dat2$Country == 27] <- "Peru"
dat2$Country[dat2$Country == 28] <- "Philippines"
dat2$Country[dat2$Country == 29] <- "Poland"
dat2$Country[dat2$Country == 30] <- "Portugal"
dat2$Country[dat2$Country == 31] <- "Russia"
dat2$Country[dat2$Country == 32] <- "Serbia"
dat2$Country[dat2$Country == 33] <- "Singapore"
dat2$Country[dat2$Country == 34] <- "South Africa"
dat2$Country[dat2$Country == 35] <- "South Korea"
dat2$Country[dat2$Country == 36] <- "Spain"
dat2$Country[dat2$Country == 37] <- "Sweden"
dat2$Country[dat2$Country == 38] <- "Taiwan"
dat2$Country[dat2$Country == 39] <- "Turkey"
dat2$Country[dat2$Country == 40] <- "UK"
dat2$Country[dat2$Country == 41] <- "US"
dat2$Country[dat2$Country == 42] <- "Venezuela"
dat2$Country <- as.factor(dat2$Country)
```

## Creating new variable - grouping by region
```{r}
dat2$Region = NA
dat2$Region <- as.character(dat2$Region)
## Nordic
dat2$Region[dat2$Country %in% "Sweden"] <- "Nordic"
dat2$Region[dat2$Country %in% "Finland"] <- "Nordic"
## Anglo
dat2$Region[dat2$Country %in% "Australia"] <- "Anglo"
dat2$Region[dat2$Country %in% "New Zealand"] <- "Anglo"
dat2$Region[dat2$Country %in% "UK"] <- "Anglo"
dat2$Region[dat2$Country %in% "Canada"] <- "Anglo"
dat2$Region[dat2$Country %in% "US"] <- "Anglo"
## Western Europe
dat2$Region[dat2$Country %in% "Greece"] <- "Western Europe"
dat2$Region[dat2$Country %in% "Italy"] <- "Western Europe"
dat2$Region[dat2$Country %in% "Portugal"] <- "Western Europe"
dat2$Region[dat2$Country %in% "Spain"] <- "Western Europe"
dat2$Region[dat2$Country %in% "Germany"] <- "Western Europe"
dat2$Region[dat2$Country %in% "Netherlands"] <- "Western Europe"
## Confucian Asia
dat2$Region[dat2$Country %in% "Japan"] <- "Confucian Asia"
dat2$Region[dat2$Country %in% "South Korea"] <- "Confucian Asia"
dat2$Region[dat2$Country %in% "Taiwan"] <- "Confucian Asia"
dat2$Region[dat2$Country %in% "China"] <- "Confucian Asia"
dat2$Region[dat2$Country %in% "Hong Kong"] <- "Confucian Asia"
## Eastern Europe
dat2$Region[dat2$Country %in% "Hungary"] <- "Eastern Europe"
dat2$Region[dat2$Country %in% "Turkey"] <- "Eastern Europe"
dat2$Region[dat2$Country %in% "Serbia"] <- "Eastern Europe"
dat2$Region[dat2$Country %in% "Russia"] <- "Eastern Europe"
dat2$Region[dat2$Country %in% "Poland"] <- "Eastern Europe"
## South East Asia
dat2$Region[dat2$Country %in% "Singapore"] <- "South East Asia"
dat2$Region[dat2$Country%in% "Indonesia"] <- "South East Asia"
dat2$Region[dat2$Country %in% "Malaysia"] <- "South East Asia"
dat2$Region[dat2$Country %in% "Philippines"] <- "South East Asia"
## Latin America
dat2$Region[dat2$Country %in% "Bolivia"] <- "Latin America"
dat2$Region[dat2$Country %in% "Argentina"] <- "Latin America"
dat2$Region[dat2$Country %in% "Panama"] <- "Latin America"
dat2$Region[dat2$Country %in% "Peru"] <- "Latin America"
dat2$Region[dat2$Country %in% "Colombia"] <- "Latin America"
dat2$Region[dat2$Country %in% "Mexico"] <- "Latin America"
dat2$Region[dat2$Country %in% "Venezuela"] <- "Latin America"
dat2$Region[dat2$Country %in% "Brazil"] <- "Latin America"
## Northern Africa
dat2$Region[dat2$Country %in% "Egypt"] <- "Northern Africa"
dat2$Region[dat2$Country %in% "Morocco"] <- "Northern Africa"
## SubS. Africa
dat2$Region[dat2$Country %in% "South Africa"] <- "SubS. Africa"
dat2$Region[dat2$Country %in% "Kenya"] <- "SubS. Africa"
dat2$Region[dat2$Country %in% "Nigeria"] <- "SubS. Africa"
## South Asian
dat2$Region[dat2$Country %in% "Pakistan"] <- "South Asian"
dat2$Region[dat2$Country %in% "India"] <- "South Asian"
dat2$Region <- as.factor(dat2$Region)
```

## exploring missing data
```{r}
any(is.na(dat2))
sum(is.na(dat2))
colSums(is.na(dat2))
which(is.na(dat2$Country))
## Removing missing values from the country column
dat2 <- dat2[!(is.na(dat2$Country)), ]
```

## turning of scientific notation
```{r}
options(scipen = 999) 
```

## Creating new variable - how did participants report income
```{r}
dat2$income_report = NA
dat2$income_report <- as.character(dat2$income_report)
dat2[ which(dat2$Income_1 != FALSE), "income_report" ] = "Daily" 
dat2[ which(dat2$Income_2 != FALSE), "income_report" ] = "Weekly"
dat2[ which(dat2$Income_3 != FALSE), "income_report" ] = "Monthly"
dat2[ which(dat2$Income_4 != FALSE), "income_report" ] = "Annually"
dat2$income_report <- factor(dat2$income_report, levels = c("Annually", "Monthly",
                                                            "Weekly", "Daily"))
```


## Bar plot of income reporting styles by country
```{r}
library(forcats)
library(RColorBrewer)
 incomeplot <- ggplot(dat2, aes(x = Country, fill = income_report)) +
  geom_bar(width = 0.6, size = 0.6, alpha = 0.8, position = position_fill(reverse = TRUE)) +
           scale_y_continuous(expand = expansion(0)) +
  scale_fill_discrete(name = NULL,
    labels = c("Annually", "Monthly", "Weekly", "Daily")
  ) +
           scale_fill_manual(name = NULL,
                             values = c(brewer.pal(4, "Dark2"))) +
  theme(
          plot.margin = unit(c(1, 1, 1, 1), "cm"),
    panel.background = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks.x = element_blank(),
          text = element_text(size = 10),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = .2),
    legend.background = element_rect(color = "black")
  ) +
  labs(title = "Income Report Stacked Barplot",
       x = "Country",
       y = "Proportion"
       ) 
```

## Save income report plot as a pdf file
```{r}
ggsave("incomereport_plot.pdf", plot = incomeplot)
```

## Changing income_report variable from character to numeric
## daily = 1 / weekly = 2 / monthly = 3 / annually = 4

```{r}
dat2$income_report2 = NA
dat2$income_report2[dat2$income_report == "Daily"] = "1"
dat2$income_report2[dat2$income_report == "Weekly"] = "2"
dat2$income_report2[dat2$income_report == "Monthly"] = "3"
dat2$income_report2[dat2$income_report == "Annually"] = "4"
dat2$income_report2 <- as.numeric(dat2$income_report2)
```

## Conspiracy theory graphs of interest
```{r}
dat2$Conspiracy_Theory <- as.numeric(dat2$Conspiracy_Theory)
dat2$PolOrientation <- as.factor(dat2$PolOrientation)
dat2$System_Justification <- as.numeric(dat2$System_Justification)
dat2 %>% ggplot(aes(x = PolOrientation, y = Conspiracy_Theory)) +
        geom_col(aes(fill = PolOrientation))
dat2 %>% ggplot(aes(x = PolEngagement_Voting, y =Conspiracy_Theory)) +
        geom_col(aes(fill = PolEngagement_Voting))
dat2 %>% ggplot(aes(x = PolEngagement_Civic, y =Conspiracy_Theory)) +
        geom_col(aes(fill = PolEngagement_Voting))
dat2 %>% ggplot(aes(x = System_Justification, y =Conspiracy_Theory)) +
        geom_col(aes(fill = PolEngagement_Voting))
## build a profile based upon these measures for who is conspiracy thinking
## think cross-culturally - country level indexes in relation to conspiracy 
## thinking 
## cor con and pol interest
cor(dat2$Conspiracy_Theory, dat2$PolEngagement_Voting, use = "complete.obs")
cor(dat2$Conspiracy_Theory, dat2$PolEngagement_Civic, use = "complete.obs")
cor(dat2$Conspiracy_Theory, dat2$PolEngagement_Voice, use = "complete.obs")
cor(dat2$Conspiracy_Theory, dat2$System_Justification, use = "complete.obs")
```

## Creating Social Mobility index
## Data accessed from 
## https://www.weforum.org/reports/global-social-mobility-index-2020-why-economies-benefit-from-fixing-inequality/#country-rankings 
```{r}
dat2 <- dat2 %>%
  mutate(Social_Mobility = ifelse(Country == "Argentina", 57.3,
    ifelse(Country == "Australia", 75.1,
      ifelse(Country == "Brazil", 52.1,
        ifelse(Country == "Bolivia", 48.2,
          ifelse(Country == "Canada", 76.1,
            ifelse(Country == "China", 61.5,
              ifelse(Country == "Colombia", 59.3,
                ifelse(Country == "Egypt", 44.8,
                  ifelse(Country == "Finland", 83.6,
                    ifelse(Country == "Germany", 78.8,
                      ifelse(Country == "Greece", 59.8,
                        ifelse(Country == "Hong Kong", 61.5,
                          ifelse(Country == "Hungary", 65.8,
                            ifelse(Country == "India", 42.7,
                              ifelse(Country == "Indonesia", 49.3,
                                ifelse(Country == "Italy", 67.4,
                                  ifelse(Country == "Japan", 76.1,
                                    ifelse(Country == "Kenya", 45.8,
                                      ifelse(Country == "Malaysia", 62.0,
                                        ifelse(Country == "Mexico", 52.6,
                                          ifelse(Country == "Morocco", 41.2,
                                            ifelse(Country == "Netherlands", 82.4,
                                              ifelse(Country == "New Zealand", 74.3,
                                                ifelse(Country == "Nigeria", 38.8,
                                                  ifelse(Country == "Pakistan", 36.7,
                                                    ifelse(Country == "Panama", 51.4,
                                                      ifelse(Country == "Peru", 49.9,
                                                        ifelse(Country == "Philippines", 51.7,
                                                          ifelse(Country == "Poland", 69.1,
                                                            ifelse(Country == "Portugal", 72.0,
                                                              ifelse(Country == "Russia", 64.7,
                                                                ifelse(Country == "Serbia", 63.8,
                                                                  ifelse(Country == "Singapore", 74.6,
                                                                    ifelse(Country == "South Africa", 41.4,
                                                                      ifelse(Country == "South Korea", 71.4,
                                                                        ifelse(Country == "Spain", 70.0,
                                                                          ifelse(Country == "Sweden", 83.5,
                                                                            ifelse(Country == "Taiwan", 61.5,
                                                                              ifelse(Country == "Turkey", 51.3,
                                                                                ifelse(Country == "UK", 74.4,
                                                                                  ifelse(Country == "US", 70.4,
                                                                                    ifelse(Country == "Venezuela", 64.4,
                                                                                           "")
                                                                                  )
                                                                                )
                                                                              )
                                                                            )
                                                                          )
                                                                        )
                                                                      )
                                                                    )
                                                                  )
                                                                )
                                                              )
                                                            )
                                                          )
                                                        )
                                                      )
                                                    )
                                                  )
                                                )
                                              )
                                            )
                                          )
                                        )
                                      )
                                    )
                                  )
                                )
                              )
                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          )
        )
      )
    )
  ))
```

## Adding GINI coeffcient scores (larger scores indicate greater inequality)
## Adding Freedom/Civil Liberty Scores (Larger scores indicate greater freedom)
```{r}
dat2 <- dat2 %>%
  mutate(GINI = ifelse(Country == "Argentina", 42.3,
    ifelse(Country == "Australia", 33.0,
      ifelse(Country == "Brazil", 48.9,
        ifelse(Country == "Bolivia", 43.6,
          ifelse(Country == "Canada", 33.0,
            ifelse(Country == "China", 48.0,
              ifelse(Country == "Colombia", 54.2,
                ifelse(Country == "Egypt", 31.0,
                  ifelse(Country == "Finland", 27.0,
                    ifelse(Country == "Germany", 31.0,
                      ifelse(Country == "Greece", 33.0,
                        ifelse(Country == "Hong Kong", 53.0,
                          ifelse(Country == "Hungary", 30.0,
                            ifelse(Country == "India", 47.0,
                              ifelse(Country == "Indonesia", 37.0,
                                ifelse(Country == "Italy", 35.0,
                                  ifelse(Country == "Japan", 29.0,
                                    ifelse(Country == "Kenya", 41.0,
                                      ifelse(Country == "Malaysia", 42.0,
                                        ifelse(Country == "Mexico", 45.4,
                                          ifelse(Country == "Morocco", 35.0,
                                            ifelse(Country == "Netherlands", 29.0,
                                              ifelse(Country == "New Zealand", 32.0,
                                                ifelse(Country == "Nigeria", 35.0,
                                                  ifelse(Country == "Pakistan", 29.0,
                                                    ifelse(Country == "Panama", 49.0,
                                                      ifelse(Country == "Peru", 43.8,
                                                        ifelse(Country == "Philippines", 42.0,
                                                          ifelse(Country == "Poland", 30.0,
                                                            ifelse(Country == "Portugal", 32.0,
                                                              ifelse(Country == "Russia", 35.0,
                                                                ifelse(Country == "Serbia", 34.0,
                                                                  ifelse(Country == "Singapore", 35.6,
                                                                    ifelse(Country == "South Africa", 63.0,
                                                                      ifelse(Country == "South Korea", 31.0,
                                                                        ifelse(Country == "Spain", 34.0,
                                                                          ifelse(Country == "Sweden", 26.0,
                                                                            ifelse(Country == "Taiwan", 34.0,
                                                                              ifelse(Country == "Turkey", 41.0,
                                                                                ifelse(Country == "UK", 36.0,
                                                                                  ifelse(Country == "US", 41.0,
                                                                                    ifelse(Country == "Venezuela", 46.0,
                                                                                           "")
                                                                                  )
                                                                                )
                                                                              )
                                                                            )
                                                                          )
                                                                        )
                                                                      )
                                                                    )
                                                                  )
                                                                )
                                                              )
                                                            )
                                                          )
                                                        )
                                                      )
                                                    )
                                                  )
                                                )
                                              )
                                            )
                                          )
                                        )
                                      )
                                    )
                                  )
                                )
                              )
                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          )
        )
      )
    )
  ))
dat2 <- dat2 %>%
  mutate(Freedom = ifelse(Country == "Argentina", 84,
    ifelse(Country == "Australia", 95,
      ifelse(Country == "Brazil", 73,
        ifelse(Country == "Bolivia", 66,
          ifelse(Country == "Canada", 98,
            ifelse(Country == "China", 9,
              ifelse(Country == "Colombia", 64,
                ifelse(Country == "Egypt", 18,
                  ifelse(Country == "Finland", 100,
                    ifelse(Country == "Germany", 94,
                      ifelse(Country == "Greece", 87,
                        ifelse(Country == "Hong Kong", 43,
                          ifelse(Country == "Hungary", 69,
                            ifelse(Country == "India", 66,
                              ifelse(Country == "Indonesia", 59,
                                ifelse(Country == "Italy", 90,
                                  ifelse(Country == "Japan", 96,
                                    ifelse(Country == "Kenya", 48,
                                      ifelse(Country == "Malaysia", 66,
                                        ifelse(Country == "Mexico", 60,
                                          ifelse(Country == "Morocco", 37,
                                            ifelse(Country == "Netherlands", 97,
                                              ifelse(Country == "New Zealand", 99,
                                                ifelse(Country == "Nigeria", 43,
                                                  ifelse(Country == "Pakistan", 37,
                                                    ifelse(Country == "Panama", 83,
                                                      ifelse(Country == "Peru", 72,
                                                        ifelse(Country == "Philippines", 55,
                                                          ifelse(Country == "Poland", 81,
                                                            ifelse(Country == "Portugal", 95,
                                                              ifelse(Country == "Russia", 19,
                                                                ifelse(Country == "Serbia", 62,
                                                                  ifelse(Country == "Singapore", 47,
                                                                    ifelse(Country == "South Africa", 79,
                                                                      ifelse(Country == "South Korea", 83,
                                                                        ifelse(Country == "Spain", 90,
                                                                          ifelse(Country == "Sweden", 100,
                                                                            ifelse(Country == "Taiwan", 94,
                                                                              ifelse(Country == "Turkey", 32,
                                                                                ifelse(Country == "UK", 93,
                                                                                  ifelse(Country == "US", 83,
                                                                                    ifelse(Country == "Venezuela", 14,
                                                                                           "")
                                                                                  )
                                                                                )
                                                                              )
                                                                            )
                                                                          )
                                                                        )
                                                                      )
                                                                    )
                                                                  )
                                                                )
                                                              )
                                                            )
                                                          )
                                                        )
                                                      )
                                                    )
                                                  )
                                                )
                                              )
                                            )
                                          )
                                        )
                                      )
                                    )
                                  )
                                )
                              )
                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          )
        )
      )
    )
  ))
```


## Adding political party in power
## Data collected from https://datacatalog.worldbank.org/search/dataset/0039819
## 0 = right, 1 = center, 2 = left
```{r}
dat2 <- dat2 %>%
  mutate(polpartypower = ifelse(Country == "Argentina", 2,
    ifelse(Country == "Australia", 2,
      ifelse(Country == "Brazil", 2,
        ifelse(Country == "Bolivia", 2,
          ifelse(Country == "Canada", 0,
            ifelse(Country == "China", 2,
              ifelse(Country == "Colombia", 0,
                ifelse(Country == "Egypt", 1,
                  ifelse(Country == "Finland", 0,
                    ifelse(Country == "Germany", 0,
                      ifelse(Country == "Greece", 2,
                        ifelse(Country == "Hong Kong", 1,
                          ifelse(Country == "Hungary", 0,
                            ifelse(Country == "India", 2,
                              ifelse(Country == "Indonesia", 2,
                                ifelse(Country == "Italy", 0,
                                  ifelse(Country == "Japan", 0,
                                    ifelse(Country == "Kenya", 1,
                                      ifelse(Country == "Malaysia", 2,
                                        ifelse(Country == "Mexico", 0,
                                          ifelse(Country == "Morocco", 0,
                                            ifelse(Country == "Netherlands", 2,
                                              ifelse(Country == "New Zealand", 2,
                                                ifelse(Country == "Nigeria", 0,
                                                  ifelse(Country == "Pakistan", 2,
                                                    ifelse(Country == "Panama", 1,
                                                      ifelse(Country == "Peru", 2,
                                                        ifelse(Country == "Philippines", 1,
                                                          ifelse(Country == "Poland", 1,
                                                            ifelse(Country == "Portugal", 0,
                                                              ifelse(Country == "Russia", 1,
                                                                ifelse(Country == "Serbia", 2,
                                                                  ifelse(Country == "Singapore", 1,
                                                                    ifelse(Country == "South Africa", 2,
                                                                      ifelse(Country == "South Korea", 2,
                                                                        ifelse(Country == "Spain", 2,
                                                                          ifelse(Country == "Sweden", 2,
                                                                            ifelse(Country == "Taiwan", 0,
                                                                              ifelse(Country == "Turkey", 0,
                                                                                ifelse(Country == "UK", 0,
                                                                                  ifelse(Country == "US", 0,
                                                                                    ifelse(Country == "Venezuela", 2,
                                                                                           "")
                                                                                  )
                                                                                )
                                                                              )
                                                                            )
                                                                          )
                                                                        )
                                                                      )
                                                                    )
                                                                  )
                                                                )
                                                              )
                                                            )
                                                          )
                                                        )
                                                      )
                                                    )
                                                  )
                                                )
                                              )
                                            )
                                          )
                                        )
                                      )
                                    )
                                  )
                                )
                              )
                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          )
        )
      )
    )
  ))
```

## Making a subset of the data for ANALYSES
```{r}
INCOMECLEAN <- subset(dat2, select = c(
  "ResponseId","Country", "Region", "age", "Gender", "PolOrientation", "Total_Income_usd",
  "PPP", "LOG10USDINCOME", "LOGPPP", "income_percent", "RegIncome", "income_report",
  "income_report2", "Education", "WellinSociety", "LifeSatisfatction_1", 
  "LifeSatisfatction_2", "Life_Satisfaction", "SJ1", "SJ2", "SJ3", "SJ4", 
  "System_Justification", "SDO", "Social_Mobility",
  "GINI", "Freedom", "polpartypower", "Conspiracy_Theory", "FeelingThermometer_1",
  "FeelingThermometer_2", "GlobalTrustInventory_Knowledge", "ClimateChange",
  "Meaning_of_Life", "Loneliness", "Subjectivewellbeing1", "Subjectivewellbeing2", "Subjectivewellbeing3",
  "Subjectivewellbeing4", "Subjectivewellbeing5", "Subjectivewellbeing6", "Subjectivewellbeing7",
  "Subjwellbeing8", "Subjwellbeing9", "Subjewellbeing10", "Subjectivewellbeig11",
  "Subjwellbeing12", "Subjwellbeing13", "Subjwellbeing14", "Subjwellbeing15",
  "Global_SelfAssessedH", "Identity2"
))
INCOMECLEAN$GINI <- as.numeric(INCOMECLEAN$GINI)
INCOMECLEAN$LOG10USDINCOME <- as.numeric(INCOMECLEAN$LOG10USDINCOME)
INCOMECLEAN$Identity2 <- as.numeric(INCOMECLEAN$Identity2)
INCOMECLEAN$LOGPPP <- as.numeric(INCOMECLEAN$LOGPPP)
INCOMECLEAN$Freedom <- as.numeric(INCOMECLEAN$Freedom)
INCOMECLEAN$System_Justification <- as.numeric(INCOMECLEAN$System_Justification)
INCOMECLEAN$PolOrientation <- as.numeric(INCOMECLEAN$PolOrientation)
INCOMECLEAN$Total_Income_usd <- as.numeric(INCOMECLEAN$Total_Income_usd)
INCOMECLEAN$Education <- as.numeric(INCOMECLEAN$Education)
INCOMECLEAN$WellinSociety <- as.numeric(INCOMECLEAN$WellinSociety)
INCOMECLEAN$Life_Satisfaction <- as.numeric(INCOMECLEAN$Life_Satisfaction)
INCOMECLEAN$Social_Mobility <- as.numeric(INCOMECLEAN$Social_Mobility)
INCOMECLEAN$polpartypower <- as.numeric(INCOMECLEAN$polpartypower)
INCOMECLEAN$age <- as.numeric(INCOMECLEAN$age)
INCOMECLEAN$Gender <- as.factor(INCOMECLEAN$Gender)
INCOMECLEAN$Conspiracy_Theory <- as.numeric(INCOMECLEAN$Conspiracy_Theory)
INCOMECLEAN$SDO <- as.numeric(INCOMECLEAN$SDO)
INCOMECLEAN$Loneliness <- as.numeric(INCOMECLEAN$Loneliness)
INCOMECLEAN$FeelingThermometer_1 <- as.numeric(INCOMECLEAN$FeelingThermometer_1)
INCOMECLEAN$FeelingThermometer_2 <- as.numeric(INCOMECLEAN$FeelingThermometer_2)
INCOMECLEAN$GlobalTrustInventory_Knowledge <- as.numeric(INCOMECLEAN$GlobalTrustInventory_Knowledge)
INCOMECLEAN$ClimateChange <- as.numeric(INCOMECLEAN$ClimateChange)
INCOMECLEAN$Meaning_of_Life <- as.numeric(INCOMECLEAN$Meaning_of_Life)
INCOMECLEAN$SJ1 <- as.numeric(INCOMECLEAN$SJ1)
INCOMECLEAN$SJ2 <- as.numeric(INCOMECLEAN$SJ2)
INCOMECLEAN$SJ3 <- as.numeric(INCOMECLEAN$SJ3)
INCOMECLEAN$SJ4 <- as.numeric(INCOMECLEAN$SJ4)
INCOMECLEAN$LifeSatisfatction_1 <- as.numeric(INCOMECLEAN$LifeSatisfatction_1)
INCOMECLEAN$LifeSatisfatction_2 <- as.numeric(INCOMECLEAN$LifeSatisfatction_2)
```

## Creating a general subjective wellbeing item
```{r}
INCOMECLEAN <- INCOMECLEAN %>%
  mutate(gensubwellbeing = Subjectivewellbeing1 + Subjectivewellbeing2 +
    Subjectivewellbeing3 + Subjectivewellbeing4 + Subjectivewellbeing5 +
    Subjectivewellbeing6 + Subjectivewellbeing7 + Subjwellbeing8 +
    Subjwellbeing9 + Subjewellbeing10 + Subjectivewellbeig11 +
    Subjwellbeing12 + Subjwellbeing13 + Subjwellbeing14 + Subjwellbeing15)
```


## Demographic descriptives (Age and Gender) of total sample
```{r}
## RUN THIS LINE OF CODE WHEN ONLY GETTING DESCRIPTIVE (REMOVING GENDER NA'S)
INCOMECLEAN <- INCOMECLEAN[!(is.na(INCOMECLEAN$Gender)), ]
INCOMECLEAN$Gender2 <- factor(INCOMECLEAN$Gender2, levels = c(1, 2),
                              labels = c("Male", "Female"))
label(INCOMECLEAN$age) <- "Age"
label(INCOMECLEAN$Gender2) <- "Gender"
## Creating descriptive for demographics
summary(INCOMECLEAN$Gender2)
mean(INCOMECLEAN$age, na.rm = T)
sd(INCOMECLEAN$age, na.rm = T)
attach(INCOMECLEAN)
vars_for_table <- c("age", "Gender2")
CreateTableOne(vars = vars_for_table, data = INCOMECLEAN)
```

## Calculating Cronbach's Alpha for SJ and life satisfaction scales
```{r}
library(ltm)
cronbachalphaSJ <- subset(INCOMECLEAN,
                          select = c(SJ1, SJ2, SJ3, SJ4))
cronbach.alpha(cronbachalphaSJ, na.rm = T)
cronbachalphaLS <- subset(INCOMECLEAN,
                         select = c(LifeSatisfatction_1, LifeSatisfatction_2))
cronbach.alpha(cronbachalphaLS, na.rm = T)
```

## Country-level descriptives of variables of interest
```{r}
## System Justifcation
INCOMECLEAN %>%
        group_by(Country) %>%
        summarise(mean = mean(System_Justification, na.rm = T),
                  sd = sd(System_Justification, na.rm = T),
                  miss = mean(is.na(System_Justification)))
## Log income
INCOMECLEAN %>%
        group_by(Country) %>%
        summarise(mean = mean(LOG10USDINCOME, na.rm = T),
                  sd = sd(LOG10USDINCOME, na.rm = T),
                  miss = mean(is.na(LOG10USDINCOME)))
## Income regularity 
INCOMECLEAN %>%
        group_by(Country) %>%
        summarise(mean = mean(RegIncome, na.rm = T),
                  sd = sd(RegIncome, na.rm = T),
                  miss = mean(is.na(RegIncome)))
## Education
INCOMECLEAN %>%
        group_by(Country) %>%
        summarise(mean = mean(Education, na.rm = T),
                  sd = sd(Education, na.rm = T),
                  miss = mean(is.na(Education)))
## Subjective SES
INCOMECLEAN %>%
        group_by(Country) %>%
        summarise(mean = mean(WellinSociety, na.rm = T),
                  sd = sd(WellinSociety, na.rm = T),
                  miss = mean(is.na(WellinSociety)))
## Political Orientation
INCOMECLEAN %>%
        group_by(Country) %>%
        summarise(mean = mean(PolOrientation, na.rm = T),
                  sd = sd(PolOrientation, na.rm = T),
                  miss = mean(is.na(PolOrientation)))
## Life Satisfaction
INCOMECLEAN4 %>%
        group_by(Country) %>%
        summarise(mean = mean(Life_Satisfaction, na.rm = T),
                  sd = sd(Life_Satisfaction, na.rm = T),
                  miss = mean(is.na(Life_Satisfaction)))
## National Identity
INCOMECLEAN %>%
        group_by(Country) %>%
        summarise(mean = mean(Identity2, na.rm = T),
                  sd = sd(Identity2, na.rm = T),
                  miss = mean(is.na(Identity2)))
```

##  system justification correlations at the individual level within Countries
```{r}
## log Income
INCOMECLEAN %>%
        group_by(Country) %>%
        drop_na(LOG10USDINCOME) %>%
        do(data.frame(correlation = cor(.$System_Justification, .$LOG10USDINCOME, method = "pearson"),
                      pvalue = cor.test(.$System_Justification, .$LOG10USDINCOME)$p.value))

cor(System_Justification, LOG10USDINCOME)
## Income regularity
INCOMECLEAN %>%
        group_by(Country) %>%
        drop_na(RegIncome) %>%
        do(data.frame(correlation = cor(.$System_Justification, .$RegIncome, method = "pearson"),
                      pvalue = cor.test(.$System_Justification, .$RegIncome)$p.value))
## Education
INCOMECLEAN %>%
        group_by(Country) %>%
        drop_na(LOG10USDINCOME) %>%
        do(data.frame(correlation = cor(.$System_Justification, .$Education, method = "pearson"),
                      pvalue = cor.test(.$System_Justification, .$Education)$p.value))
## Subjective SES
INCOMECLEAN %>%
        group_by(Country) %>%
        drop_na(LOG10USDINCOME) %>%
        do(data.frame(correlation = cor(.$System_Justification, .$WellinSociety, method = "pearson"),
                      pvalue = cor.test(.$System_Justification, .$WellinSociety)$p.value))
## Political orientation
INCOMECLEAN %>%
        group_by(Country) %>%
        drop_na(PolOrientation) %>%
        do(data.frame(correlation = cor(.$System_Justification, .$PolOrientation, method = "pearson"),
                      pvalue = cor.test(.$System_Justification, .$PolOrientation)$p.value))
## Life Satisfaction
INCOMECLEAN %>%
        group_by(Country) %>%
        drop_na(Life_Satisfaction, System_Justification) %>%
        do(data.frame(correlation = cor(.$System_Justification, .$Life_Satisfaction, method = "pearson"),
                      pvalue = cor.test(.$System_Justification, .$Life_Satisfaction)$p.value))
## National Identity
INCOMECLEAN %>%
        group_by(Country) %>%
        drop_na(Identity2) %>%
        do(data.frame(correlation = cor(.$System_Justification, .$Identity2, method = "pearson"),
                      pvalue = cor.test(.$System_Justification, .$Identity2)$p.value))
```

## Country-level correlations (N = 42)
```{r, warning=FALSE}
smallcor <- subset(INCOMECLEAN, select = c("System_Justification", "LOG10USDINCOME",
                                           "Education", "WellinSociety", "PolOrientation", 
                                           "Life_Satisfaction", "GINI", "Freedom",
                                           "Social_Mobility", "polpartypower"))
chart.Correlation(smallcor)
apa.cor.table(smallcor, filename = "Country_level_correlations.doc")
apa.cor.table(incomecor, filename = "INCOME_CORRELATIONS.doc", table.number = 1)
```


## Calculating ICC's for each variable of interest
```{r}
## SJ
icc_sj <- lmer(System_Justification ~ 1 + (1|Country), data = INCOMECLEAN)
ICC(icc_sj)

## income
icc_income <- lmer(LOG10USDINCOME ~ 1 + (1|Country), data = INCOMECLEAN)
ICC(icc_income)
##education
icc_education <- lmer(Education ~ 1 + (1|Country), data=INCOMECLEAN)
ICC(icc_education)

## subjective SES
icc_subjective_ses <- lmer(WellinSociety ~ 1 + (1|Country), data = INCOMECLEAN)
ICC(icc_subjective_ses)

## Life Satisfaction
icc_life_satisfaction <- lmer(Life_Satisfaction ~ 1 + (1|Country), data = INCOMECLEAN)
ICC(icc_life_satisfaction)

## Political orientation
icc_political_orientation <- lmer(PolOrientation ~ 1 + (1|Country), data = INCOMECLEAN)
ICC(icc_political_orientation)

## AGE
icc_age <- lmer(age ~ 1 + (1|Country), data = INCOMECLEAN)
ICC(icc_age)

## Gender
icc_gender <- lmer(Gender ~ 1 + (1|Country), data = INCOMECLEAN)
ICC(icc_gender)
```
## modeling univariates
```{r}
flexplot(System_Justification~1, INCOMECLEAN)
flexplot(Education~1, INCOMECLEAN)
flexplot(income_centered~1, INCOMECLEAN2)
flexplot(WellinSociety~1, INCOMECLEAN)
flexplot(PolOrientation~1, INCOMECLEAN)
flexplot(Life_Satisfaction~1, INCOMECLEAN)
```

## Data prep for H1A-H1B
```{r}
## Grand mean centering level 1 and level 2 variables
INCOMECLEAN$age <- scale(INCOMECLEAN$age, center = T, scale = F)

INCOMECLEAN$income_centered = NA
INCOMECLEAN$income_centered <- scale(INCOMECLEAN$LOG10USDINCOME, center = T, scale = F)

INCOMECLEAN$education_centered = NA
INCOMECLEAN$education_centered <- scale(INCOMECLEAN$Education, center = T, scale = F)

INCOMECLEAN$PolOrientation <- scale(INCOMECLEAN$PolOrientation,
                          center = T, scale = F)

INCOMECLEAN$Social_Mobility <- scale(INCOMECLEAN$Social_Mobility, 
                         center = T, scale = F)

INCOMECLEAN$Freedom <- scale(INCOMECLEAN$Freedom, 
                         center = T, scale = F)

INCOMECLEAN$GINI <- scale(INCOMECLEAN$GINI, center = T, scale = T)
## Creating seperate dataset for H1A and H1B tests due to removal of extreme
## Values
## Removing extreme  outliers from income
INCOMECLEAN2 <- INCOMECLEAN
INCOMECLEAN2 <- subset(INCOMECLEAN2, income_centered <= 7)
INCOMECLEAN2 <- subset(INCOMECLEAN2, income_centered >= -6)
```

## Writing two working datasets for analyses
```{r}
write_sav(INCOMECLEAN2, "H1A and H1B Data")

write_sav(INCOMECLEAN, "H1C_to_H4B_Data")
```

## START RUNNING CODE FROM HERE ________________________________________________
## Calling up WORKING datasets
```{r}
H1A_H1B_DATA <- read_sav("H1A and H1B Data")

H1C_H4B_DATA <- read_sav("H1C_to_H4B_Data")
```

## Attaching country names for h1a/h1b data
```{r}

H1A_H1B_DATA$Country <- as.character(H1A_H1B_DATA$Country)
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 1] <- "Argentina"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 2] <- "Australia"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 3] <- "Bolivia"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 4] <- "Brazil"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 5] <- "Canada"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 6] <- "China"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 7] <- "Colombia"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 8] <- "Egypt"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 9] <- "Finland"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 10] <- "Germany"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 11] <- "Greece"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 12] <- "Hong Kong"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 13] <- "Hungary"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 14] <- "India"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 15] <- "Indonesia"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 16] <- "Italy"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 17] <- "Japan"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 18] <- "Kenya"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 19] <- "Malaysia"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 20] <- "Mexico"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 21] <- "Morocco"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 22] <- "Netherlands"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 23] <- "New Zealand"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 24] <- "Nigeria"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 25] <- "Pakistan"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 26] <- "Panama"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 27] <- "Peru"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 28] <- "Philippines"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 29] <- "Poland"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 30] <- "Portugal"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 31] <- "Russia"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 32] <- "Serbia"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 33] <- "Singapore"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 34] <- "South Africa"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 35] <- "South Korea"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 36] <- "Spain"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 37] <- "Sweden"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 38] <- "Taiwan"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 39] <- "Turkey"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 40] <- "UK"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 41] <- "US"
H1A_H1B_DATA$Country[H1A_H1B_DATA$Country == 42] <- "Venezuela"
H1A_H1B_DATA$Country <- as.factor(H1A_H1B_DATA$Country)
```

## Attaching country names for h1c - h4b data
```{r}
H1C_H4B_DATA$Country <- as.character(H1C_H4B_DATA$Country)
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 1] <- "Argentina"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 2] <- "Australia"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 3] <- "Bolivia"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 4] <- "Brazil"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 5] <- "Canada"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 6] <- "China"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 7] <- "Colombia"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 8] <- "Egypt"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 9] <- "Finland"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 10] <- "Germany"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 11] <- "Greece"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 12] <- "Hong Kong"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 13] <- "Hungary"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 14] <- "India"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 15] <- "Indonesia"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 16] <- "Italy"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 17] <- "Japan"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 18] <- "Kenya"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 19] <- "Malaysia"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 20] <- "Mexico"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 21] <- "Morocco"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 22] <- "Netherlands"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 23] <- "New Zealand"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 24] <- "Nigeria"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 25] <- "Pakistan"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 26] <- "Panama"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 27] <- "Peru"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 28] <- "Philippines"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 29] <- "Poland"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 30] <- "Portugal"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 31] <- "Russia"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 32] <- "Serbia"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 33] <- "Singapore"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 34] <- "South Africa"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 35] <- "South Korea"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 36] <- "Spain"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 37] <- "Sweden"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 38] <- "Taiwan"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 39] <- "Turkey"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 40] <- "UK"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 41] <- "US"
H1C_H4B_DATA$Country[H1C_H4B_DATA$Country == 42] <- "Venezuela"
H1C_H4B_DATA$Country <- as.factor(H1C_H4B_DATA$Country)
```

### RESULTS ______________________________
## Please NOTE THAT WE ARE NOT USING FORWARD STEPPING IN BUILDING ANY OF THE 
## FOLLOWING MULTILEVEL MODELS AS RECOMMENDED BY NEZLEK (2008) AS WE ARE 
## FIRST ATTEMPTING TO FIT THE DESIRED PREREGISTERED (COMPLEX) MODELS FIRST AND
## COMPARING THEM TO SIMILAR YET LESS COMPLEX MODELS W/ THE REMOVAL OF SPECIFIC
## RANDOM EFFECTS. AFTER COMPARISONS WE LOOK AT RESIDUAL DISTRIBUTIONS OF MODELS 
## SPECIFIFED AND TAKE INTO ACCOUNT CONVERGENCE ISSUES AND ATTEMPT TO REDUCE USING
## RECOMMENDED METHODS BY MEYTERD & DAVIES (2020). WE STATE IN CODE CHUNKS WHEN
## WE OPT TO SELECT THE LESS COMPLEX MODEL

## Chaning gender to nonnumeric
```{r}
H1A_H1B_DATA$Gender2 <- factor(H1A_H1B_DATA$Gender2, levels = c(1, 2),
                              labels = c("Male", "Female"))

H1C_H4B_DATA$Gender2 <- factor(H1C_H4B_DATA$Gender2, levels = c(1, 2),
                              labels = c("Male", "Female"))
```

## Multilevel Modeling 
## Hypotheses 1A - 1C
```{r}
## removing missing cases specific to H1A-H1B in accord with preregistration
## and to allow models to be compared via identical cases

H1A_H1B_DATA <- H1A_H1B_DATA %>%
        drop_na(System_Justification, Gender2, age)

## Intercept only model
SJ_NULLMODEL <- lmer(System_Justification ~ 1 + (1 | Country),
                             data = H1A_H1B_DATA, REML = F, 
                     control = lmerControl(optimizer = "bobyqa"))

tab_model(SJ_NULLMODEL)
summary(SJ_NULLMODEL)
estimates(SJ_NULLMODEL)

## random intercept null model 
SJ_NULLMODEL <- lmer(System_Justification ~ 1 + (1 | Country),
                             data = H1C_H4B_DATA, REML = F)
tab_model(SJ_NULLMODEL) ## 17% variance in SJ explained by country
summary(SJ_NULLMODEL)
estimates(SJ_NULLMODEL) ## Design effect

## Calculate the 95% CI for the ICC
ICC(SJ_NULLMODEL)
library(ICC)
ICCest(x = Country, y = System_Justification, 
       data = H1C_H4B_DATA, alpha = 0.05, CI.type = "THD")
```

```{r}
# Hypothesis 1A + H1B Objective SES predicting SJ

## Model 2 -introducing level one preidctors and random intercepts/slopes for 
##income and education
H1A_B_Reduced2 <- lmer(System_Justification ~ 1 + income_centered + education_centered + Gender2 + age +
  (1 + income_centered + education_centered | Country),
data = H1A_H1B_DATA, REML = F,
control = lmerControl(optimizer = "bobyqa")
) ## Converged

summary(H1A_B_Reduced2)
tab_model(H1A_B_Reduced2)


H1A_B_full <- lmer(System_Justification ~ 1 + income_centered + education_centered + Gender2 + age +
  (1 + income_centered + education_centered | Country) + (0 + Gender2 + age | Country),
data = H1A_H1B_DATA, REML = F,
control = lmerControl(optimizer = "bobyqa")
) ## Converges

summary(H1A_B_full)

## model comparison
visualize(H1A_B_full, plot = "residuals")
anova(SJ_NULLMODEL, H1A_B_Reduced2, H1A_B_full)
## Residuals within full model look normally distributed and model comparison
## favors the full model at all levels


## results for best fitting model
summary(H1A_B_full)
estimates(H1A_B_full) ## ICC and design effect provide support for multilevel modeling
tab_model(H1A_B_full)


## building a table for both h1a and h1b
tab_model(SJ_NULLMODEL, H1A_B_Reduced2, H1A_B_full, file = "H1A_B_model.doc")

## Visualize random effects in H1 A and B
plot_h1a_b_1 <- visualize(H1A_B_full,
  plot = "model",
  formula = System_Justification ~ income_centered + Country,
  sample = 42, raw.data = F
) +
  labs(
    x = "Income",
    y = "System Justification"
  ) + theme_apa() +
        theme(legend.position = "none")

save_plot("H1A_B_income.pdf", plot = plot_h1a_b_1)

plot_h1a_b_2 <- visualize(H1A_B_full,
  plot = "model",
  formula = System_Justification ~ education_centered + Country,
  sample = 42, raw.data = F
) +
  labs(
    x = "Education",
    y = "System Justification"
  ) +
        theme_apa() +
        theme(legend.position = "none")
        
save_plot("H1A_B_education.pdf", plot = plot_h1a_b_2)
```


# Hypothesis 1C - Relationship between subjective SES and SJ mediated by LS
```{r}
## Grand mean centering level 1 predictor/mediator
H1C_H4B_DATA$WellinSociety <- scale(H1C_H4B_DATA$WellinSociety, 
                                    center = T, scale = F)
H1C_H4B_DATA$Life_Satisfaction <- scale(H1C_H4B_DATA$Life_Satisfaction,
                                        center = T, scale = F)

## Removing cases that do not have complete cases for H1C as reported in the
## preregistration
H1C_data <- H1C_H4B_DATA %>%
        drop_na(System_Justification, WellinSociety, Life_Satisfaction)

library(mediation)

## intercept only model
H1C_NULL_model <- lmer(System_Justification ~ 1 + (1|Country),
                       data = H1C_data, REML = F, 
                       control = lmerControl(optimizer = "bobyqa"))
tab_model(H1C_NULL_model)

## checking A path / creating A path for mediate model
H1C_Mediate_model <- lmer(Life_Satisfaction ~ WellinSociety +
                                  (1 + WellinSociety | Country), 
                          data = H1C_data, REML = F, control = lmerControl(optimizer = "bobyqa"))

summary(H1C_Mediate_model)
tab_model(H1C_Mediate_model)

## Checking B path
b_path <- lmer(System_Justification ~ 1 + Life_Satisfaction + WellinSociety+ age + Gender2 +
                       (1 + WellinSociety | Country), data = H1C_data, REML = F,
               control = lmerControl(optimizer = "bobyqa"))
summary(b_path)
tab_model(b_path)

## Checking C path
c_path <- lmer(System_Justification ~ 1 + WellinSociety + age + Gender2 +
                       (1 + WellinSociety | Country),
               data = H1C_data, REML = F, 
               control = lmerControl(optimizer = "bobyqa"))
summary(c_path)
tab_model(c_path)

H1C_Full_model <- lmer(System_Justification ~ 1 + Life_Satisfaction +
  WellinSociety + age + Gender2 +
  (1 + WellinSociety | Country),
data = H1C_data, REML = F, control = lmerControl(optimizer = "bobyqa")
)

summary(H1C_Full_model)
tab_model(H1C_Full_model)
## Evidence of partial mediation 
## Bivariate relationship between subjective SES (wellinsociety) and SJ 
## Decreases after the introduction of mediator (life satisfaction)
## Does not allow age gender to have random slopes in model - we will continue
## to control for both age and gender but remove them from the random effects

H1C_results <- mediation::mediate(H1C_Mediate_model, H1C_Full_model,
                       treat = "WellinSociety", mediator = "Life_Satisfaction", 
                       sims = 1000, dropobs = TRUE)

summary(H1C_results)
H1C_results
estimates(H1C_Full_model)
tab_model(H1C_Full_model)

visualize(H1C_Full_model, plot = "model",
          formula = System_Justification~WellinSociety + Country |
                  Life_Satisfaction,
          sample = 42, raw.data = F)

 flexplot(System_Justification~WellinSociety + Life_Satisfaction,
         data = H1C_data, se = FALSE, method = "lm", sample = 100)
 
 mediate_plot(System_Justification ~ Life_Satisfaction + WellinSociety, 
              data = H1C_data) 
 ## Visualization of the partial mediation relationship between 
 ## black line is the direct effect prior to introduction of mediator, 
 ## Blue line is the relationship once you take into account the mediator 
 
 ## Sobel test 
 library(multilevel)
 sobel(H1C_data$WellinSociety, H1C_data$Life_Satisfaction,
       H1C_data$System_Justification)

## Indirect effect is sig < .05
## the indirect effect is positive (0.06906148), which means that higher levels 
## of subjective SES in society are associated with higher levels of system 
## justification through the mediator of life satisfaction.
## the indirect effect has a medium strength (0.06906148), indicating that the 
## mediator explains a moderate proportion of the total effect.
## Overall, the Sobel test suggests that life satisfaction partially mediates the 
## relationship between well-being in society and system justification, with a 
## significant positive indirect effect
 
## Building a table of multilevel models of each of the paths
tab_model(H1C_NULL_model, H1C_Mediate_model, b_path, c_path, H1C_Full_model,
          file = "H1C_multilevel_table.doc")
```


## Hypotheses 2A - 2B at the country level
```{r, warning=FALSE}
H2A_B_data <- H1C_H4B_DATA %>%
        drop_na(System_Justification, PolOrientation, age, Gender2)


## Model 1 H2A and H2B intercept only model
h2a_b_null <- lmer(System_Justification~1 + (1|Country), data = H2A_B_data,
                   REML = F, control = lmerControl(optimizer = "bobyqa"))

## Model 2 H2A
## introduction of level 1 predictors/covariates and random effects of pol. orientation
H2A_country_reduced <- lmer(System_Justification ~ 1 + PolOrientation + age + Gender2 +
                    (1 + PolOrientation | Country),
                    data = H2A_B_data,
                    REML = F, control = lmerControl(optimizer = "bobyqa")) 

##  Model 3 H2A 
## Political ideology predicting SJ at country level introducing
## random slope for age and gender
H2A_country_full <- lmer(System_Justification ~ 1 + PolOrientation + age + Gender2 +
                    (1 + PolOrientation | Country) + (0 + age + Gender2 | Country),
                    data = H2A_B_data,
                    REML = F, control=lmerControl(optimizer="bobyqa")) 
## All models converge


## Model comparisons
anova(h2a_b_null, H2A_country_reduced, H2A_country_full)
visualize(H2A_country_full, plot = "residuals")
## All model comparison factors favor the full model over the reduced
## Based upon this, the better fitting  would be 
## full model (Meteyard, L., & Davies, R. A.,  2020. Best practice guidance for 
## linear mixed-effects models in psychological science. Journal of Memory and 
## Language, 112, 104092.)


estimates(H2A_country_full)
summary(H2A_country_full)
tab_model(H2A_country_full)

H2A_plot_Country <- visualize(H2A_country_full, plot = "model",
          formula = System_Justification~PolOrientation + Country,
          sample = 42, raw.data = F) +
        labs(x = "Political Orientation",
             y = "System Justifcation") +
        theme_apa() +
        theme(legend.position = "none")

## Building a table for multilevel models for H2A
tab_model(h2a_b_null, H2A_country_reduced, H2A_country_full,
          file = "H2A_table.doc")

## Create figure for slopes
save_plot("h2a_plot.pdf", H2A_plot_Country)


## Hypothesis 2B - Relationship between political ideology and SJ moderated by 
## Political party in power
H2A_B_data$polpartypower_fac <- factor(H2A_B_data$polpartypower, levels = c(
        0, 1, 2), labels = c("Right", "Center", "Left"))

## Setting reference level for pol party in power
reference_level <- "Right"
H2A_B_data$polpartypower_fac <- relevel(H2A_B_data$polpartypower_fac,
                                          ref = reference_level)


## Introducing level 1 predictors and covariates with random effects for political
## orientation
H2B_base_model_country <- lmer(System_Justification ~ 1 + PolOrientation + age + Gender2 +
                    (1 + PolOrientation | Country),
                    data = H2A_B_data,
                    REML = F, control = lmerControl(optimizer = "bobyqa"))

## Introducing level 2 moderator / interaction while cutting random effects for 
## gender and age
H2B_Moderation_reducedmodel_Country <- lmer(System_Justification ~ 1 + PolOrientation + 
                                     polpartypower_fac + PolOrientation*polpartypower_fac +
                                             age + Gender2 +
                                     (1 + PolOrientation | Country),
                             data = H2A_B_data, REML = F)

## Full model with level 2 interaction and random effects for pol orientation,
## age and gender

H2B_Moderation_fullmodel_Country <- lmer(System_Justification ~ 1 + PolOrientation + 
                                     polpartypower_fac + PolOrientation*polpartypower_fac +
                                             age + Gender2 +
                                     (1 + PolOrientation  | Country) + 
                                             (0 + age + Gender2 | Country),
                             data = H2A_B_data, REML = F,
                             control=lmerControl(optimizer="bobyqa")) 
## converges



## Checking model comparison
anova(h2a_b_null, H2B_base_model_country, H2B_Moderation_reducedmodel_Country, H2B_Moderation_fullmodel_Country)
visualize(H2B_Moderation_fullmodel_Country, plot = "residuals")
## Residuals appear normally distributed in full model indicating good fit
## Model comparisons favor the full model once again suggesting to ignore the 
## lme4 convergence issues to report the better fitting model in accord with
## (Meteyard & Davies, 2020)

summary(H2B_Moderation_fullmodel_Country)
simple_slopes(H2B_Moderation_fullmodel_Country)
estimates(H2B_Moderation_fullmodel_Country)
tab_model(H2B_Moderation_fullmodel_Country)




H2B_plot_Country <- visualize(H2B_Moderation_fullmodel_Country, plot = "model",
          formula = System_Justification~PolOrientation + Country | 
                  polpartypower_fac,
                  sample = 42, raw.data = F) +
         labs(x = "Political Orientation",
                y = "System Justification") +
        theme_apa() +
        theme(legend.position = "none") +
        facet_wrap(polpartypower_fac ~ .)

## interaction plot
H2B_interaction_plot <- plot_model(H2B_Moderation_fullmodel_Country, type = "int") +
        theme_apa() +
        labs(x = "Political Orientation",
             y = "System Justification",
             title = NULL)


save_plot("H2B_Plot_country.pdf", plot = H2B_plot_Country)
save_plot("h2b_interactionplot.pdf", plot = H2B_interaction_plot)

## Building a table of multilevel models for h2b
tab_model(h2a_b_null, H2B_base_model_country, H2B_Moderation_reducedmodel_Country,
          H2B_Moderation_fullmodel_Country,
          file = "H2B_country_Model.doc")
```



## Hypotheses 3A - 3B at the Country level
```{r, warning=FALSE}
## Creating data for specific analyses as reported in preregistration
## No missingness in level 2 predictor/moderator
H3A_B_data <- H1C_H4B_DATA %>%
        drop_na(age, Gender2, System_Justification)
H3A_B_data$GINI <- scale(H3A_B_data$GINI, center = T, scale = T)


## Intercept only model
H3A_NULLMODEL <- lmer(System_Justification ~ 1 + (1|Country),
                      data = H3A_B_data, REML = F,
                      control = lmerControl(optimizer = "bobyqa"))

## Introduction of level 2 predictor and level 1 covariates with random intercept 
H3A_reduced_Country <- lmer(System_Justification ~ GINI + age + Gender2 +
                    (1 | Country), 
                    data = H3A_B_data, REML = F, 
                    control=lmerControl(optimizer="bobyqa")) 

## Hypothesis 3A - Economic inequality predicting SJ introducing random slopes
## for theoretical covariates age and gender (Preregistered model)
H3A_full_Country <- lmer(System_Justification ~ GINI + age + Gender2 +
                    (1 | Country) + (0 + age + Gender2 | Country), 
                    data = H3A_B_data, REML = F, 
                    control=lmerControl(optimizer="bobyqa"))
 
## all models converge properly


## Model comparison
anova(H3A_NULLMODEL, H3A_reduced_Country, H3A_full_Country)
visualize(H3A_full_Country, plot = "residuals")
## Model comparisons indicate that the better fitting model is once again the 
## full model. Residuals look normally distributed indicating good fit.

estimates(H3A_full_Country)
summary(H3A_full_Country)
tab_model(H3A_full_Country)
simple_slopes(H3A_full_Country)

H3A_plot_Country <- visualize(H3A_full_Country, plot = "model",
          formula = System_Justification~GINI + Country, sample = 42, raw.data = F) +
        labs(x = "GINI", y = "System Justification") +
        theme_apa() +
        theme(legend.position = "none")

save_plot("h3a_plot.pdf", plot = H3A_plot_Country)

## Building a table for multilevel model H3A
tab_model(H3A_NULLMODEL, H3A_reduced_Country, H3A_full_Country,
          file = "H3A_Table.doc")
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Converting social mobility into a factor of high medium and low

H3A_B_data$Social_Mobility_factor <- cut(H3A_B_data$Social_Mobility, 
                                          breaks = c(-Inf, -0.5, 0.5, Inf), 
                                          labels = c("Low", "Medium", "High"))

Social_Mobility_reference_level <- "Low"
H3A_B_data$Social_Mobility_factor <- relevel(H3A_B_data$Social_Mobility_factor,
                                          ref = Social_Mobility_reference_level)

## Hypothesis 3B base model with introduction of level 2 predictor and level 1
## covariates with random intercepts 
## Model 2
H3B_base_model_Country <- lmer(System_Justification ~ 1 + GINI + age + Gender2 +
  (1 | Country),
data = H3A_B_data, REML = F, control = lmerControl(optimizer = "bobyqa")
)


## Introduction of second level two moderator (country level objective social mobility) 
## and random slopes for theoretical covariates (age and gender)
## Model 3
H3B_Moderation_reduced_model_country <- lmer(System_Justification ~ GINI * 
                                Social_Mobility_factor + age + Gender2 + 
                                        (1 | Country), data = H3A_B_data, REML = F,
control = lmerControl(optimizer = "bobyqa")
)

H3B_Moderation_full_Model_Country <- lmer(System_Justification ~ GINI * Social_Mobility_factor +
  age + Gender2 +
  (1 | Country) + (0 + age + Gender2 | Country),
data = H3A_B_data, REML = F,
control = lmerControl(optimizer = "bobyqa")
)


## All models converge without issue 

## model comparisons
anova(H3A_NULLMODEL,H3B_base_model_Country, 
      H3B_Moderation_reduced_model_country, H3B_Moderation_full_Model_Country)

visualize(H3B_Moderation_full_Model_Country, plot = "residuals")

## According to the model comparison the best fitting model is the most 
## complex theorized preregistered model as can be seen by the recommendations 
## of Meteyard & Davies (2020) & Nezlek (2008)

summary(H3B_Moderation_full_Model_Country)
estimates(H3B_Moderation_full_Model_Country)
tab_model(H3B_Moderation_full_Model_Country)
simple_slopes(H3B_Moderation_full_Model_Country)


H3B_plot_Country <- visualize(H3B_Moderation_reduced_model_country, plot = "model",
          formula = System_Justification~GINI + Country | Social_Mobility_factor ,
          raw.data = F, sample = 42) + 
        labs(x = "GINI",
             y = "System Justification") +
        theme_apa() +
        theme(legend.position = "none") +
        facet_wrap(Social_Mobility_factor ~ .)


H3B_interaction_plot <- plot_model(H3B_Moderation_full_Model_Country, type = "int") +
        theme_apa() +
        labs(x = "GINI",
             y = "System Justification",
             title = NULL)


save_plot("H3B_plot_Country.pdf", H3B_plot_Country)
save_plot("H3B_interaction_plot.pdf", H3B_interaction_plot)

## Building table for H3A and B at region level
tab_model(H3A_NULLMODEL, H3B_base_model_Country, H3B_Moderation_reduced_model_country,
          H3B_Moderation_full_Model_Country,
          file = "H3B_Country_Model.doc")
```

## Hypothesis 4A - 4B at the country level
```{r}

## H4A & H4B - Freedom predicting SJ at Country level
H4A_B_Country_full_model <- lmer(System_Justification ~ Freedom + age + Gender2 +
                                     (1 | Country) + (0 + age + Gender2 | Country),
               data = H1C_H4B_DATA, REML = F, control=lmerControl(optimizer="bobyqa"))


H4A_B_Country_reduced_model <- lmer(System_Justification ~ Freedom + age + Gender2 
                                    + (1 | Country),
               data = H1C_H4B_DATA, REML = F, control=lmerControl(optimizer="bobyqa"))
## more complex full model is not identifiable - convergence issues
## Reduced model converges without issue

## model comparisons
model.comparison(H4A_B_Country_full_model, H4A_B_Country_reduced_model)
visualize(H4A_B_Country_reduced_model, plot = "residuals")
## model comparisons once again favor the full model but due to model convergence 
## issues we will opt for the reduced model missing the random effects for age/gender
## Residuals are normally distributed

summary(H4A_B_Country_reduced_model)
estimates(H4A_B_Country_reduced_model)
tab_model(H4A_B_Country_reduced_model)

H4A_B_Plot_Country <- visualize(H4A_4B_Country_model, plot = "model",
          formula = System_Justification ~ Freedom + Country,
          sample = 42, raw.data = F) +
        labs(y = "System Justification",
             x = "Freedom")

ggsave("H4A_B_plot_country.pdf", plot = H4A_B_Plot_Country, width = 4, height = 4)

## Building table for H4A and B at Country level
tab_model(H4A_4B_Country_model, file = "H4A_B_Country_Model.doc")
```


##______________________________________________________________________________
## EXPLORATORY ANALYSES - NOT PART OF PREREGISTRATION
## Hypotheses 2A - 2B at the region level
```{r}
## Hypothesis 2A - Political ideology predicting SJ at country level
H2A_region <- lmer(System_Justification ~ 1 + PolOrientation + age + Gender2 +
                    (1 + PolOrientation | Region) + (0 + age + Gender2 | Region),
                   data = INCOMECLEAN,
                   REML = F)

summary(H2A_region)
tab_model(H2A_region)

H2A_plot_Region <- visualize(H2A_region, plot = "model",
          formula = System_Justification~PolOrientation + Region,
          sample = 10, raw.data = F) +
        labs(x = "Political Orientation",
             y = "System Justifcation") +
        theme(legend.position = "none")

## Hypothesis 2B - Relationship between political ideology and SJ moderated by 
## Political party in power
H2B_base_model_region <- lmer(System_Justification ~ 1 + PolOrientation + age + Gender2 +
                    (1 + PolOrientation | Region) + (0 + age + Gender2 | Region),
                   data = INCOMECLEAN,
                   REML = F)


H2B_Moderation_model_region <- lmer(System_Justification ~ 1 + PolOrientation + 
                                     polpartypower_fac + PolOrientation*polpartypower_fac +
                                            age + Gender2 +
                                     (1 + PolOrientation | Region) +
                                            (0 + age + Gender2 | Region),
                             data = INCOMECLEAN, REML = F)

summary(H2B_Moderation_model_region)
simple_slopes(H2B_Moderation_model_region)
tab_model(H2B_Moderation_model_region)

 H2b_plot_Region <- visualize(H2B_Moderation_model_region, plot = "model",
          formula = System_Justification~PolOrientation + Region | 
                  polpartypower_fac,
                  sample = 10, raw.data = F) +
        labs(x = "Political Orientation",
             y = "System Justifcation") +
         theme(legend.position = "none")

visualize(H2B_Moderation_model_region, plot = "residuals")

H2A_B_region_plots <- plot_grid(H2A_plot_Region, H2b_plot_Region)

save_plot("H2A_B_region_plot.png", H2A_B_region_plots)


## Building a table for both h2a and h2b
tab_model(H2A_region, H2B_Moderation_model_region, file = "H2A_B_region_model.doc")
```

## Hypotheses 3A - 3B at the region level
```{r}
INCOMECLEAN$GINI <- as.numeric(INCOMECLEAN$GINI)
## Grand mean centering GINI for multilevel models
INCOMECLEAN$GINI <- scale(INCOMECLEAN$GINI, 
                         center = T, scale = T)

## Hypothesis 3A - Economic inequality predicting SJ
H3A <- lmer(System_Justification ~ 1 + GINI + age + Gender2 +
                    (1 | Region) + (0 + age + Gender2 | Region),
            data = INCOMECLEAN, REML = F)

summary(H3A)
tab_model(H3A)

H3A_plot_Region <- visualize(H3A, plot = "model",
          formula = System_Justification~GINI + Region, sample = 10, raw.data = F) +
        labs(x = "GINI",
             y = "System Justification") + theme(legend.position = "none")

visualize(H3A, plot = "residuals")

## Hypothesis 3B
## Grand mean center social mobility for multilevel model
INCOMECLEAN$Social_Mobility <- scale(INCOMECLEAN$Social_Mobility, 
                         center = T, scale = T)

H3B_base_model <- lmer(System_Justification ~ 1 + GINI + age + Gender2 + 
                    (1 | Region) + (0 + age + Gender2 | Region),  
                    data = INCOMECLEAN, REML = F)

H3B_Moderation_Model <- lmer(System_Justification ~ 1 + GINI*Social_Mobility +
                                     age + Gender2 +(1 | Region) + (0 + age + Gender2 | Region), 
                             data = INCOMECLEAN, REML = F)

summary(H3B_Moderation_Model)
tab_model(H3B_Moderation_Model)

H3B_plot_Region <- visualize(H3B_Moderation_Model, plot = "model",
          formula = System_Justification~GINI + Region | Social_Mobility,
          sample = 10, raw.data = F) +
        labs(x = "GINI",
             y = "System Justification") + theme(legend.position = "none")

H3A_B_region_plots <- plot_grid(H3A_plot_Region, H3B_plot_Region)

save_plot("H3A_B_region_plot.png", H3A_B_region_plots)

## Building table for H3A and B at region level
tab_model(H3A, H3B_Moderation_Model, file = "H3A_B_Region_Model.doc")
```

## Hypotheses 4A - 4B at the Region level
```{r}
## H4A & H4B - Freedom predicting SJ at Country level
H4A_4B_Region_model <- lmer(System_Justification ~ 1 + Freedom + age + Gender2 + 
                                    (1 | Region) + (0 + age + Gender2 | Region),
               data = INCOMECLEAN, REML = F)

summary(H4A_4B_Region_model)
tab_model(H4A_4B_Region_model)

H4A_B_plot_Region <- visualize(H4A_4B_Region_model, plot = "model",
          formula = System_Justification~Freedom + Region,
          sample = 10, raw.data = F) +
        labs(x = "Freedom",
             y = "System Justification") 

save_plot("H4A_B_region_plot.png", H4A_B_plot_Region)

## Building table for H4A and B at Region level
tab_model(H4A_4B_Region_model, file = "H4A_B_Region_Model.doc")
```




## _____________________________________________________________________________
## WAGES/INCOME ANALYSES FOR JAMES/STU

## Visualizing income outliers
```{r}
boxplot(INCOMECLEAN2$Total_Income_usd)
boxplot(INCOMECLEAN2$LOG10USDINCOME)
INCOMECLEAN2 <- INCOMECLEAN2 %>%
        filter(Total_Income_usd < 1000000)
INCOMECLEAN2 <- INCOMECLEAN2 %>%
        filter(LOG10USDINCOME < 15)
boxplot(INCOMECLEAN2$Total_Income_usd)
boxplot(INCOMECLEAN2$LOG10USDINCOME)
```


```{r}
## Removing NA from Gender
INCOMECLEAN2 <- INCOMECLEAN2[!(is.na(INCOMECLEAN2$Gender)), ]
INCOMECLEAN2 %>%
        ggplot(aes(x=Gender, y=Conspiracy_Theory, fill=Gender)) +
        geom_boxplot() +
        facet_wrap(~Region)+
        theme(
    panel.background = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks.x = element_blank(),
          text = element_text(size = 10),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = .2),
    legend.background = element_rect(color = "black"))
    
```

## Income Regularity and life satisfaction
```{r}
INCOMECLEAN2$income_report2 <- as.factor(INCOMECLEAN2$income_report2)
INCOMECLEAN2 <- INCOMECLEAN2[!(is.na(INCOMECLEAN2$income_report2)), ]
INCOMECLEAN2 %>%
        ggplot(aes(x = Total_Income_usd, y = Life_Satisfaction, 
                   colour = income_report)) +
        geom_jitter(size = 1) +
        xlim(0, 100000) +
        facet_wrap(~Country) +
        theme(
    panel.background = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks.x = element_blank(),
          text = element_text(size = 10),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = .2),
    legend.background = element_rect(color = "black")
  ) +
        labs(title = "Relationship between income and life satisfaction",
             x = "income",
             y = "life satisfaction")
```

## Violin plot of income density by region
```{r}
INCOMECLEAN2$PolOrientation <- as.factor(INCOMECLEAN2$PolOrientation)
 INCOMECLEAN2 %>%
        ggplot(aes(x = Region, y = LOG10USDINCOME, 
                   fill = Region)) +
        geom_violin() +
        geom_dotplot(binaxis = "y", binwidth = 0.01, 
                     stackdir = "center") +
        theme(
    panel.background = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks.x = element_blank(),
          text = element_text(size = 10),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = .2),
    legend.background = element_rect(color = "black")
  )+
        labs(title = "Income density by region",
             x = "Region",
             y = "Income")
## Saving violin plot of income density by region
ggsave("income_density.pdf", plot = violinplot)
```

## Conspiracy beliefs
```{r}
 Conspiracyplot <- INCOMECLEAN %>%
   ggplot(aes(x = LOG10USDINCOME,
                   y = Conspiracy_Theory)) +
        geom_jitter(size = .5)+
        geom_smooth(formula = y ~ x, method = "lm") +
        facet_wrap(~Country) +
        ylim(0, 7) +
        xlim(-2, 7) +
  theme(
    panel.background = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks.x = element_blank(),
          text = element_text(size = 10),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = .2),
    legend.background = element_rect(color = "black")
  ) +
        labs(title = "CONSPIRACY BELIEFS EXPLAINED BY INCOME",
             x = "Income",
             y = "Conspiracy Beliefs")
ggsave("conspiracyplot.pdf", Conspiracyplot)
```

```{r}
INCOMECLEAN2 %>%
        ggplot(aes())
```

## Income and life satisfaction by Country
```{r}
  INCOMECLEAN %>%
        ggplot(aes(x = LOG10USDINCOME,
                   y = Life_Satisfaction)) +
        geom_jitter()+
        geom_smooth(formula = y ~ x, method = "lm") +
        facet_wrap(~Country) +
        ylim(0, 7) +
        xlim(-4, 7) +
  theme(
    panel.background = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks.x = element_blank(),
          text = element_text(size = 10),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = .2),
    legend.background = element_rect(color = "black")
  ) +
        labs(title = "LIFE SATISFACTION EXPLAINED BY INCOME",
             x = "Income",
             y = "Life satisfaction",
             fill = "Income Regularity")
## Saving Income and life satisfaction by Country
ggsave("income_lifesat.pdf", plot = income_lifesat)
```

```{r}
INCOMECLEAN2 %>%
        ggplot(aes(x = LOG10USDINCOME,
                   y = Life_Satisfaction,
                   colour = PolOrientation)) +
        geom_jitter()+
        geom_abline(intercept = 3.6, slope = 0.06) +
        facet_wrap(~Country) +
        ylim(0, 7) +
        xlim(-4, 7) +
        scale_color_gradient(low = "red", high = "green") +
  theme(
    panel.background = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks.x = element_blank(),
          text = element_text(size = 10),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = .2),
    legend.background = element_rect(color = "black")
  ) +
        labs(title = "LIFE SATISFACTION EXPLAINED BY INCOME",
             x = "Income",
             y = "Life satisfaction",
             fill = "Political Orientation")
```

## Income Regularity and life satisfaction
```{r}
INCOMECLEAN2$income_report2 <- as.numeric(INCOMECLEAN2$income_report2)
INCOMECLEAN2 %>% 
        ggplot(aes(x = Life_Satisfaction,
                   y = income_report2, 
                   colour = PolOrientation)) +
        geom_jitter(size = 1) +
        facet_wrap(~Country) +
        xlim(0, 10) +
        ylim(0, 5) +
        labs(title = "LIFE SATISFACTION EXPLAINED BY INCOME REGULARITY",
             x = "Life satisfaction",
             y = "Income Regularity")
```




```{r}
INCOMECLEAN2 <- INCOMECLEAN2 %>% 
  mutate(PPP = signif(PPP))
  
```


## Using Density / heatmaps to reveal structure in income data
```{r}
library(gridExtra)
library(colorspace)
p = ggplot(INCOMECLEAN2, aes(x = LOG10USDINCOME, y = Life_Satisfaction)) +
        ggtitle("Plot of income and life sat") +
        xlab("Income") +
        ylab("Life Satisfaction")
p1 = p +
        geom_point(alpha = 0.01, colour = "orange") +
        geom_density2d() +
        theme_bw()
p2 = p +
        stat_bin_hex(colour = "white", na.rm = T) +
        scale_fill_gradientn(colours = c("purple", "green"),
                             name = "Frequency",
                             na.value = NA)
grid.arrange(p1, p2, ncol = 2)
```

```{r}
library(RColorBrewer)
buylrd = c("#313695", "#4575B4", "#74ADD1", "#ABD9E9", "#E0F3F8", "#FFFFBF",
           "#FEE090", "#FDAE61", "#F46D43", "#D73027", "#A50026") 
myColRamp = colorRampPalette(c(buylrd))
## Smoothed scatterplot
smoothScatter(x = INCOMECLEAN2$LOG10USDINCOME, y = INCOMECLEAN2$Life_Satisfaction,
              colramp = myColRamp)
```


## -----------------------------------------------------------------
## Subet of Financially Distressed regions/countries
```{r}
Vendata <- subset(INCOMECLEAN2, Country == "Venezuela")
Kendata <- subset(INCOMECLEAN2, Country == "Kenya")
Nigdata <- subset(INCOMECLEAN2, Country == "Nigeria")
SAdata <- subset(INCOMECLEAN2, Country == "South Africa")
FINANCEDISTRESSED1 <- rbind(Nigdata, Kendata)
FINANCEDISTRESSED2 <- rbind(SAdata, FINANCEDISTRESSED1)
FULLFINANCEDISTRESSED <- rbind(Vendata, FINANCEDISTRESSED2)
```

```{r}
plot(FULLFINANCEDISTRESSED$gensubwellbeing, FULLFINANCEDISTRESSED$LOG10USDINCOME)
```
## LOESS modeling
```{r}
### Split DAta into train/valid
FULLFINANCEDISTRESSED %>% head()
train.split.pct <- 0.7
train.row <- runif(n = nrow(FULLFINANCEDISTRESSED)) < train.split.pct
train <- FULLFINANCEDISTRESSED[train.row, ]
valid <- FULLFINANCEDISTRESSED[!train.row, ]
nrow(train)
nrow(valid)
### LOESS function
mod <- loess(formula = gensubwellbeing ~ LOG10USDINCOME,
             data = train, 
             span = 0.3,
             degree = 1,
             normalize = TRUE)
calc.RMSE <- function(pred,act){
        sqrt(mean((pred-act)^2)/length(pred))
}
results <- matrix(NA, 0, 4)
colnames(results) <- c("span","degree", "train.rmse", "valid.rmse")
for(degree in seq(0,2,1)){
        for(span in seq(0.15,1,0.01)){
                mod <- loess(formula = gensubwellbeing ~ LOG10USDINCOME,
             data = train, 
             span = 1,
             degree = 1,
             normalize = TRUE,
             control = loess.control(surface = "direct"))
                train.rmse <- calc.RMSE(mod$fitted, train$gensubwellbeing)
                valid.rmse <- calc.RMSE(predict(mod, newdata = valid)
                                        %>% 
                                                as.data.frame(),
                                        valid$gensubwellbeing)
                
                results <- rbind(results, c(span,degree,train.rmse,valid.rmse))
        }
}
results <- as.data.frame(results)
best <- results[which.min(results$valid.rmse)]
